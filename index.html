<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eldora - Medicine Reminder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Main background using a fresh, soft gradient ("Horizon" from WebGradients) */
    body {
      background-image: linear-gradient(to right, #a1c4fd, #c2e9fb);
      font-family: 'Inter', sans-serif;
    }
    /* Appbar with a complementary deep blue gradient */
    nav {
      background-image: linear-gradient(to right, #1e3c72, #2a5298);
    }
    .nav-btn {
      background-color: transparent;
      color: white;
      border: 1px solid rgba(255,255,255,0.5);
    }
    .nav-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    /* Primary Button Styles: darker pastel blue */
    .btn-primary {
      background-color: #4a90e2;
      color: white;
    }
    .btn-primary:hover {
      background-color: #3a78c2;
    }
    /* Card Style for Medicine Reminder: slightly off white */
    .card {
      background: #f7f7f7;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    /* Increase input size and use card background color for inputs */
    input[type="text"],
    input[type="number"],
    input[type="time"] {
      background-color: #f7f7f7;
      padding: 0.75rem 1rem;
      font-size: 1rem;
    }
    .nav-btn:focus {
      outline: none;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Navigation Tabs -->
  <nav class="p-4">
    <div class="max-w-4xl mx-auto flex justify-center space-x-4">
      <button id="caregiverTab" class="nav-btn text-white font-semibold px-6 py-2 rounded shadow-lg">Caregiver</button>
      <button id="elderTab" class="nav-btn text-white font-semibold px-6 py-2 rounded shadow-lg">Elder</button>
    </div>
  </nav>

  <div class="max-w-4xl mx-auto p-6">
    <!-- Caregiver View -->
    <section id="caregiverView" class="mt-6">
      <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800">Eldora - Caregiver Dashboard</h1>
      </header>
      <!-- Medicine Reminder Form -->
      <div class="card p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Set Medicine Reminder</h2>
        <form id="medicineForm" class="space-y-4">
          <!-- Medicine Name -->
          <div>
            <label for="medicineName" class="block text-gray-600 font-medium">Medicine Name</label>
            <input type="text" id="medicineName" name="medicineName" placeholder="e.g. Paracetamol" required />
          </div>
          <!-- Pills per Dose -->
          <div>
            <label for="pillCount" class="block text-gray-600 font-medium">Pills per Dose</label>
            <input type="number" id="pillCount" name="pillCount" placeholder="e.g. 2 pills" min="1" required />
          </div>
          <!-- Frequency (Months and Days) or Lifetime -->
          <div>
            <label class="block text-gray-600 font-medium">Frequency:</label>
            <div class="flex space-x-2 mt-1">
              <div class="w-1/2">
                <input type="number" id="freqMonths" name="freqMonths" placeholder="Months" min="0" value="0" required />
                <p class="text-xs text-gray-500 mt-1">Months</p>
              </div>
              <div class="w-1/2">
                <input type="number" id="freqDays" name="freqDays" placeholder="Days" min="0" value="3" required />
                <p class="text-xs text-gray-500 mt-1">Days</p>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-gray-600 font-medium">
              <input type="checkbox" id="lifetime" class="mr-2"> Lifetime Medication
            </label>
          </div>
          <!-- Time Slots Section -->
          <div>
            <label class="block text-gray-600 font-medium mb-2">Set Alarm Time(s)</label>
            <div id="timeSlots" class="space-y-2">
              <div class="flex space-x-2 items-center time-slot">
                <input type="time" class="startTime" required />
                <span class="self-center text-gray-600">to</span>
                <input type="time" class="endTime" required />
                <button type="button" class="removeTimeSlot bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Remove</button>
              </div>
            </div>
            <button type="button" id="addTimeSlot" class="mt-2 btn-primary px-4 py-2 rounded shadow">Add Time Slot</button>
          </div>
          <button type="submit" class="btn-primary px-4 py-2 rounded shadow-lg w-full">Set Reminder</button>
        </form>
      </div>
      <!-- Active Reminders List for Caregiver -->
      <div class="card p-6">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Active Medicine Reminders</h2>
        <div id="caregiverReminders">
          <p class="text-gray-500">No reminders set yet.</p>
        </div>
      </div>
    </section>

    <!-- Elder View -->
    <section id="elderView" class="mt-6 hidden">
      <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800">Eldora - Elder Dashboard</h1>
      </header>
      <div class="card p-6">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Your Medicine Reminders</h2>
        <div id="elderReminders">
          <p class="text-gray-500">No reminders available at the moment.</p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Helper: Convert total days into "X months Y days" format.
    function formatFrequency(days) {
      let d = parseInt(days, 10);
      if (isNaN(d)) return days;
      let months = Math.floor(d / 30);
      let remainder = d % 30;
      if (months > 0 && remainder === 0) { remainder = 15; }
      return `${months} month${months === 1 ? '' : 's'} ${remainder} day${remainder === 1 ? '' : 's'}`;
    }

    // Global reminders state.
    let reminders = [];

    // DOM elements for views.
    const caregiverForm = document.getElementById('medicineForm');
    const caregiverRemindersDiv = document.getElementById('caregiverReminders');
    const elderRemindersDiv = document.getElementById('elderReminders');
    const lifetimeCheckbox = document.getElementById('lifetime');

    // Tab navigation.
    const caregiverTab = document.getElementById('caregiverTab');
    const elderTab = document.getElementById('elderTab');
    const caregiverView = document.getElementById('caregiverView');
    const elderView = document.getElementById('elderView');

    caregiverTab.addEventListener('click', () => {
      caregiverView.classList.remove('hidden');
      elderView.classList.add('hidden');
      caregiverTab.classList.add('bg-blue-700');
      elderTab.classList.remove('bg-blue-700');
    });
    elderTab.addEventListener('click', () => {
      elderView.classList.remove('hidden');
      caregiverView.classList.add('hidden');
      elderTab.classList.add('bg-blue-700');
      caregiverTab.classList.remove('bg-blue-700');
    });

    lifetimeCheckbox.addEventListener('change', function() {
      if (this.checked) {
        document.getElementById('freqMonths').disabled = true;
        document.getElementById('freqDays').disabled = true;
      } else {
        document.getElementById('freqMonths').disabled = false;
        document.getElementById('freqDays').disabled = false;
      }
    });

    // Dynamic Time Slot Addition.
    const timeSlotsDiv = document.getElementById('timeSlots');
    const addTimeSlotBtn = document.getElementById('addTimeSlot');
    function addTimeSlot() {
      const timeSlotDiv = document.createElement('div');
      timeSlotDiv.classList.add('flex', 'space-x-2', 'items-center', 'time-slot');
      const startInput = document.createElement('input');
      startInput.type = 'time';
      startInput.required = true;
      startInput.className = 'startTime rounded-md border-gray-300 shadow-sm focus:ring-blue-500';
      const span = document.createElement('span');
      span.textContent = "to";
      span.classList.add('self-center', 'text-gray-600');
      const endInput = document.createElement('input');
      endInput.type = 'time';
      endInput.required = true;
      endInput.className = 'endTime rounded-md border-gray-300 shadow-sm focus:ring-blue-500';
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = "Remove";
      removeBtn.className = 'removeTimeSlot bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600';
      removeBtn.addEventListener('click', () => { timeSlotsDiv.removeChild(timeSlotDiv); });
      timeSlotDiv.appendChild(startInput);
      timeSlotDiv.appendChild(span);
      timeSlotDiv.appendChild(endInput);
      timeSlotDiv.appendChild(removeBtn);
      timeSlotsDiv.appendChild(timeSlotDiv);
    }
    addTimeSlotBtn.addEventListener('click', addTimeSlot);

    // Helper: Convert HH:MM to minutes from midnight.
    function timeToMinutes(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }

    // Form submission handler.
    caregiverForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const medicineName = document.getElementById('medicineName').value;
      const pillCount = document.getElementById('pillCount').value;
      let frequency;
      if (lifetimeCheckbox.checked) {
        frequency = "Life";
      } else {
        let months = parseInt(document.getElementById('freqMonths').value) || 0;
        let days = parseInt(document.getElementById('freqDays').value) || 0;
        frequency = months * 30 + days;
      }
      const timeSlotElements = document.querySelectorAll('.time-slot');
      let timeSlots = [];
      for (const slot of timeSlotElements) {
        const start = slot.querySelector('.startTime').value;
        const end = slot.querySelector('.endTime').value;
        if (!start || !end) { alert("Please fill in all time slot fields."); return; }
        const startM = timeToMinutes(start);
        const endM = timeToMinutes(end);
        let duration = endM - startM;
        if (duration <= 0) { alert("End time must be after start time."); return; }
        let interval = Math.floor(duration / 3);
        if (interval <= 0) interval = 1;
        const buffer = 5;
        let thirdAlarm = (endM - buffer > startM + interval * 2) ? (endM - buffer) : (startM + interval * 2);
        const alarmTimes = [startM + interval, startM + interval * 2, thirdAlarm];
        const alarmsTriggered = [false, false, false];
        timeSlots.push({ start, end, status: "pending", alarmTimes, alarmsTriggered });
      }
      const reminder = { id: Date.now(), medicineName, pillCount, frequency, timeSlots };
      reminders.push(reminder);
      updateViews();
      caregiverForm.reset();
      document.getElementById('freqMonths').disabled = false;
      document.getElementById('freqDays').disabled = false;
      lifetimeCheckbox.checked = false;
      timeSlotsDiv.innerHTML = "";
      addTimeSlot();
    });

    // Periodic check for alarms and missed time slots.
    setInterval(() => {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      reminders.forEach(reminder => {
        reminder.timeSlots.forEach(slot => {
          if (slot.status === "pending") {
            slot.alarmTimes.forEach((alarmTime, index) => {
              if (!slot.alarmsTriggered[index] && currentMinutes >= alarmTime) {
                alert(`Reminder for Elder: Time to take ${reminder.medicineName} (${slot.start} - ${slot.end}) [Alarm ${index+1}]`);
                slot.alarmsTriggered[index] = true;
              }
            });
            if (currentMinutes >= timeToMinutes(slot.end)) {
              slot.status = "missed";
              alert(`Alert for Caregiver: Medicine "${reminder.medicineName}" missed for time slot ${slot.start} - ${slot.end}`);
            }
          }
        });
      });
      updateViews();
    }, 10000);

    // Update views based on reminders state.
    function updateViews() {
      if (reminders.length === 0) {
        caregiverRemindersDiv.innerHTML = '<p class="text-gray-500">No reminders set yet.</p>';
      } else {
        caregiverRemindersDiv.innerHTML = reminders.map(reminder => {
          const frequencyText = reminder.frequency === "Life" ? "Lifetime" : formatFrequency(reminder.frequency);
          const timeSlotsHTML = reminder.timeSlots.map(slot => `
            <li>${slot.start} - ${slot.end} (<span class="font-semibold">${slot.status}</span>)</li>`
          ).join('');
          return `<div class="card p-4 mb-4">
              <h3 class="text-xl font-bold text-gray-800">${reminder.medicineName}</h3>
              <p class="text-gray-600">Pills per Dose: ${reminder.pillCount}</p>
              <p class="text-gray-600">Frequency: ${frequencyText}</p>
              <ul class="list-disc list-inside text-gray-600">${timeSlotsHTML}</ul>
            </div>`;
        }).join('');
      }
      if (reminders.length === 0) {
        elderRemindersDiv.innerHTML = '<p class="text-gray-500">No reminders available at the moment.</p>';
      } else {
        elderRemindersDiv.innerHTML = reminders.map(reminder => {
          const timeSlotsHTML = reminder.timeSlots.map((slot, idx) => {
            let actions = "";
            if (slot.status === "pending" || slot.status === "missed") {
              actions = `<button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" onclick="markTaken(${reminder.id}, ${idx})">Mark as Taken</button>`;
            }
            return `<li>${slot.start} - ${slot.end} (<span class="font-semibold">${slot.status}</span>) ${actions}</li>`;
          }).join('');
          return `<div class="card p-4 mb-4">
              <h3 class="text-xl font-bold text-gray-800">${reminder.medicineName}</h3>
              <p class="text-gray-600">Pills per Dose: ${reminder.pillCount}</p>
              <ul class="list-disc list-inside text-gray-600">${timeSlotsHTML}</ul>
            </div>`;
        }).join('');
      }
    }

    // Elder action: mark a specific time slot as taken.
    function markTaken(reminderId, timeslotIndex) {
      console.log(`Marking reminder ${reminderId}, timeslot ${timeslotIndex} as taken.`);
      reminders = reminders.map(reminder => {
        if (reminder.id === reminderId) {
          const slot = reminder.timeSlots[timeslotIndex];
          if (slot.status === "pending") {
            slot.status = "taken";
          } else if (slot.status === "missed") {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const slotEndMinutes = timeToMinutes(slot.end);
            const delayMinutes = currentMinutes - slotEndMinutes;
            const delayString = formatDelay(delayMinutes);
            slot.status = `taken medicine post time slot (${delayString})`;
          }
        }
        return reminder;
      });
      updateViews();
    }
    window.markTaken = markTaken;
    addTimeSlot();
  </script>
</body>
</html>

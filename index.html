<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eldora - Medicine Reminder</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Navigation Tabs -->
  <nav class="bg-blue-600 p-4">
    <div class="max-w-4xl mx-auto flex justify-center space-x-4">
      <button id="caregiverTab" class="text-white font-semibold px-4 py-2 rounded bg-blue-700">Caregiver</button>
      <button id="elderTab" class="text-white font-semibold px-4 py-2 rounded hover:bg-blue-500">Elder</button>
    </div>
  </nav>

  <div class="max-w-4xl mx-auto p-6">
    <!-- Caregiver View -->
    <section id="caregiverView" class="mt-6">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 text-center">
          Eldora - Caregiver Dashboard
        </h1>
      </header>
      <!-- Medicine Reminder Form -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">
          Set Medicine Reminder
        </h2>
        <form id="medicineForm" class="space-y-4">
          <!-- Medicine Name -->
          <div>
            <label for="medicineName" class="block text-gray-600 font-medium">
              Medicine Name
            </label>
            <input type="text" id="medicineName" name="medicineName" placeholder="e.g. Paracetamol" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
          </div>
          <!-- Number of Pills -->
          <div>
            <label for="pillCount" class="block text-gray-600 font-medium">
              Number of Pills
            </label>
            <input type="number" id="pillCount" name="pillCount" placeholder="e.g. 2 pills" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="1" required />
          </div>
          <!-- Frequency -->
          <div>
            <label for="frequency" class="block text-gray-600 font-medium">
              Frequency (Days)
            </label>
            <input type="number" id="frequency" name="frequency" min="1" max="30" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
          </div>
          <!-- Time Slots Section -->
          <div>
            <label class="block text-gray-600 font-medium mb-2">
              Set Alarm Time(s)
            </label>
            <div id="timeSlots" class="space-y-2">
              <!-- A default time slot is added automatically -->
              <div class="flex space-x-2 items-center time-slot">
                <input type="time" class="startTime rounded-md border-gray-300 shadow-sm" required />
                <span class="self-center">to</span>
                <input type="time" class="endTime rounded-md border-gray-300 shadow-sm" required />
                <button type="button" class="removeTimeSlot bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Remove</button>
              </div>
            </div>
            <button type="button" id="addTimeSlot" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              Add Time Slot
            </button>
          </div>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Set Reminder
          </button>
        </form>
      </div>
      <!-- List of Active Reminders for Caregiver -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">
          Active Medicine Reminders
        </h2>
        <div id="caregiverReminders">
          <p class="text-gray-500">No reminders set yet.</p>
        </div>
      </div>
    </section>

    <!-- Elder View -->
    <section id="elderView" class="mt-6 hidden">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 text-center">
          Eldora - Elder Dashboard
        </h1>
      </header>
      <!-- Reminders Notification List for Elder -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">
          Your Medicine Reminders
        </h2>
        <div id="elderReminders">
          <p class="text-gray-500">No reminders available at the moment.</p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Global reminders state shared by both views.
    // Each reminder includes an array of time slots,
    // where each time slot is an object: { start, end, status }
    let reminders = [];

    // DOM elements for both views
    const caregiverForm = document.getElementById('medicineForm');
    const caregiverRemindersDiv = document.getElementById('caregiverReminders');
    const elderRemindersDiv = document.getElementById('elderReminders');

    // Tab navigation elements
    const caregiverTab = document.getElementById('caregiverTab');
    const elderTab = document.getElementById('elderTab');
    const caregiverView = document.getElementById('caregiverView');
    const elderView = document.getElementById('elderView');

    // Tab switching logic
    caregiverTab.addEventListener('click', () => {
      caregiverView.classList.remove('hidden');
      elderView.classList.add('hidden');
      caregiverTab.classList.add('bg-blue-700');
      elderTab.classList.remove('bg-blue-700');
    });

    elderTab.addEventListener('click', () => {
      elderView.classList.remove('hidden');
      caregiverView.classList.add('hidden');
      elderTab.classList.add('bg-blue-700');
      caregiverTab.classList.remove('bg-blue-700');
    });

    // Dynamic Time Slot Addition
    const timeSlotsDiv = document.getElementById('timeSlots');
    const addTimeSlotBtn = document.getElementById('addTimeSlot');

    // Function to add a new time slot block
    function addTimeSlot() {
      const timeSlotDiv = document.createElement('div');
      timeSlotDiv.classList.add('flex', 'space-x-2', 'items-center', 'time-slot');

      const startInput = document.createElement('input');
      startInput.type = 'time';
      startInput.required = true;
      startInput.className = 'startTime rounded-md border-gray-300 shadow-sm';

      const span = document.createElement('span');
      span.textContent = "to";
      span.classList.add('self-center');

      const endInput = document.createElement('input');
      endInput.type = 'time';
      endInput.required = true;
      endInput.className = 'endTime rounded-md border-gray-300 shadow-sm';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = "Remove";
      removeBtn.className = 'removeTimeSlot bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600';
      removeBtn.addEventListener('click', () => {
        timeSlotsDiv.removeChild(timeSlotDiv);
      });

      timeSlotDiv.appendChild(startInput);
      timeSlotDiv.appendChild(span);
      timeSlotDiv.appendChild(endInput);
      timeSlotDiv.appendChild(removeBtn);

      timeSlotsDiv.appendChild(timeSlotDiv);
    }

    addTimeSlotBtn.addEventListener('click', addTimeSlot);

    // Caregiver: handle form submission to set a new reminder
    caregiverForm.addEventListener('submit', function(e) {
      e.preventDefault();

      // Gather form data
      const medicineName = document.getElementById('medicineName').value;
      const pillCount = document.getElementById('pillCount').value;
      const frequency = document.getElementById('frequency').value;
      
      // Gather all time slots from the dynamic container and add a status field
      const timeSlotElements = document.querySelectorAll('.time-slot');
      let timeSlots = [];
      for (const slot of timeSlotElements) {
        const start = slot.querySelector('.startTime').value;
        const end = slot.querySelector('.endTime').value;
        if (!start || !end) {
          alert("Please fill in all time slot fields.");
          return;
        }
        // Each time slot now includes its own status.
        timeSlots.push({ start, end, status: "pending" });
      }

      // Create reminder object with a unique id.
      const reminder = {
        id: Date.now(),
        medicineName,
        pillCount,
        frequency,
        timeSlots, // array of {start, end, status}
      };

      reminders.push(reminder);
      updateViews();
      caregiverForm.reset();

      // Clear dynamic time slots and add one default slot back
      timeSlotsDiv.innerHTML = "";
      addTimeSlot();
    });

    // Helper function: compares current time with an end time ("HH:MM")
    function isPast(endTime) {
      const now = new Date();
      const [endHour, endMinute] = endTime.split(':').map(Number);
      if (now.getHours() > endHour || (now.getHours() === endHour && now.getMinutes() > endMinute)) {
        return true;
      }
      return false;
    }

    // Check for missed time slots periodically (every 10 seconds for demo)
    setInterval(() => {
      reminders.forEach(reminder => {
        reminder.timeSlots.forEach((slot, index) => {
          if (slot.status === "pending" && isPast(slot.end)) {
            // Mark as missed only once
            slot.status = "missed";
            alert(`Alert for Caregiver: Medicine "${reminder.medicineName}" missed for time slot ${slot.start} - ${slot.end}`);
          }
        });
      });
      updateViews();
    }, 10000);

    // Update both caregiver and elder views based on reminders state
    function updateViews() {
      // Caregiver view: display reminder details with each time slot's status
      if (reminders.length === 0) {
        caregiverRemindersDiv.innerHTML = '<p class="text-gray-500">No reminders set yet.</p>';
      } else {
        caregiverRemindersDiv.innerHTML = reminders.map(reminder => {
          const timeSlotsHTML = reminder.timeSlots.map(slot => `<li>${slot.start} - ${slot.end} (<span class="font-semibold">${slot.status}</span>)</li>`).join('');
          return `
            <div class="border p-4 rounded mb-4 shadow-sm">
              <h3 class="text-xl font-bold text-gray-800">${reminder.medicineName}</h3>
              <p class="text-gray-600">Number of Pills: ${reminder.pillCount}</p>
              <p class="text-gray-600">Frequency: ${reminder.frequency} day(s)</p>
              <ul class="list-disc list-inside text-gray-600">
                ${timeSlotsHTML}
              </ul>
            </div>
          `;
        }).join('');
      }

      // Elder view: display reminders with action buttons for pending time slots
      if (reminders.length === 0) {
        elderRemindersDiv.innerHTML = '<p class="text-gray-500">No reminders available at the moment.</p>';
      } else {
        elderRemindersDiv.innerHTML = reminders.map(reminder => {
          const timeSlotsHTML = reminder.timeSlots.map((slot, idx) => {
            let actions = "";
            if (slot.status === "pending") {
              actions = `<button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" onclick="markTaken(${reminder.id}, ${idx})">
                           Mark as Taken
                         </button>`;
            }
            return `<li>
                      ${slot.start} - ${slot.end} (<span class="font-semibold">${slot.status}</span>) ${actions}
                    </li>`;
          }).join('');
          return `
            <div class="border p-4 rounded mb-4 shadow-sm">
              <h3 class="text-xl font-bold text-gray-800">${reminder.medicineName}</h3>
              <p class="text-gray-600">Number of Pills: ${reminder.pillCount}</p>
              <ul class="list-disc list-inside text-gray-600">
                ${timeSlotsHTML}
              </ul>
            </div>
          `;
        }).join('');
      }
    }

    // Elder action: mark a specific time slot as taken
    function markTaken(reminderId, timeslotIndex) {
      reminders = reminders.map(reminder => {
        if (reminder.id === reminderId) {
          reminder.timeSlots[timeslotIndex].status = "taken";
        }
        return reminder;
      });
      updateViews();
    }

    // Expose the elder action to global scope
    window.markTaken = markTaken;

    // Add one default time slot on page load
    addTimeSlot();
  </script>
</body>
</html>
